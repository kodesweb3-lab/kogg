// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Token {
  id          String   @id @default(uuid())
  mint        String   @unique
  name        String
  symbol      String
  imageUrl    String?
  metadataUri String
  dbcPool     String?  // DBC pool address
  creatorWallet String
  configKey   String
  tokenType   TokenType @default(MEMECOIN)
  assetType   String?   // e.g., "physical_product", "service", "real_estate", "financial_asset", "other"
  assetDescription String?  // Detailed description of the asset
  assetValue  Float?    // Estimated value in USD
  assetLocation String? // Physical location (optional)
  documents   Json?     // Array of document URLs: [{url: string, name: string, type: string}]
  createdAt   DateTime @default(now())
  
  metrics     Metric[]
  
  @@index([mint])
  @@index([creatorWallet])
  @@index([createdAt])
  @@index([tokenType])
  @@index([assetType])
}

model Metric {
  id         String   @id @default(uuid())
  tokenMint  String
  price      Float?   @default(0)
  mcap       Float?   @default(0)
  vol24h     Float?   @default(0)
  holders    Int?     @default(0)
  updatedAt  DateTime @default(now()) @updatedAt
  
  token      Token    @relation(fields: [tokenMint], references: [mint], onDelete: Cascade)
  
  @@unique([tokenMint])
  @@index([tokenMint])
  @@index([updatedAt])
}

model BotPersona {
  id          String   @id @default(uuid())
  tokenMint   String   @unique
  systemPrompt String  // Final user-owned system prompt
  traitsJson  String   // JSON string of traits array
  allowed     String?  // JSON string of allowed topics/words
  forbidden   String?  // JSON string of forbidden topics/words
  tone        String   // e.g., "meme", "professional", "shill", etc.
  // Extended persona fields (user-owned)
  personaStyleJson String? // JSON: { chaos, friendliness, formality, aggression, humor } (0-100)
  brandingJson String?     // JSON: { catchphrases, emojis, voiceStyle, doList, dontList }
  presetUsed String?        // Which preset was used (Fire/Frost/Blood/Moon/Stone) or "custom"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  
  telegramBot TelegramBot?
  
  @@index([tokenMint])
}

model TelegramBot {
  id            String      @id @default(uuid())
  tokenMint     String      @unique
  encryptedToken String     // AES-GCM encrypted BotFather token
  status        BotStatus   @default(PENDING)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @default(now()) @updatedAt
  
  persona       BotPersona  @relation(fields: [tokenMint], references: [tokenMint], onDelete: Cascade)
  
  @@index([tokenMint])
  @@index([status])
}

enum BotStatus {
  PENDING
  ACTIVE
  INACTIVE
  ERROR
}

model Comment {
  id          String   @id @default(uuid())
  tokenMint   String
  wallet      String
  content     String
  createdAt   DateTime @default(now())
  
  @@index([tokenMint])
  @@index([createdAt])
}

model Referral {
  id            String   @id @default(uuid())
  referrerWallet String
  referredWallet String
  createdAt     DateTime @default(now())
  
  @@unique([referrerWallet, referredWallet])
  @@index([referrerWallet])
  @@index([referredWallet])
}

model ServiceProvider {
  id            String   @id @default(uuid())
  wallet        String   @unique // Solana wallet address
  email         String?
  telegram      String?
  twitterHandle String?  // Twitter username (fără @)
  twitterId     String?  // Twitter user ID pentru verificare
  description   String? // Descrierea serviciilor oferite
  verified      Boolean  @default(false) // Verificat prin Twitter
  verifiedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt
  
  tags          ServiceProviderTag[]
  twitterVerification TwitterVerification?
  
  @@index([wallet])
  @@index([verified])
  @@index([createdAt])
}

model ServiceProviderTag {
  id                String   @id @default(uuid())
  serviceProviderId String
  tag               String   // Tag name (predefined sau custom)
  isCustom          Boolean  @default(false) // Dacă e tag custom
  createdAt         DateTime @default(now())
  
  serviceProvider   ServiceProvider @relation(fields: [serviceProviderId], references: [id], onDelete: Cascade)
  
  @@index([serviceProviderId])
  @@index([tag])
}

model TwitterVerification {
  id                String   @id @default(uuid())
  serviceProviderId String   @unique
  verificationCode  String   // Cod unic pentru verificare
  tweetId           String?  // ID-ul tweet-ului de verificare
  status            VerificationStatus @default(PENDING)
  createdAt         DateTime @default(now())
  verifiedAt        DateTime?
  
  serviceProvider   ServiceProvider @relation(fields: [serviceProviderId], references: [id], onDelete: Cascade)
  
  @@index([verificationCode])
  @@index([status])
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FAILED
  EXPIRED
}

enum TokenType {
  MEMECOIN
  RWA
}

model DevLog {
  id          String   @id @default(uuid())
  title       String
  content     String   // Markdown content
  category    DevLogCategory @default(UPDATE)
  status      DevLogStatus @default(COMPLETED)
  version     String?  // Optional version tag (e.g., "v1.2.0")
  isPublic    Boolean  @default(true)
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  
  @@index([publishedAt])
  @@index([category])
  @@index([status])
  @@index([isPublic])
}

enum DevLogCategory {
  UPDATE      // New features, improvements
  FIX         // Bug fixes
  ANNOUNCEMENT // Important announcements
  ROADMAP     // Future plans
  TECHNICAL   // Technical deep-dives (non-sensitive)
}

enum DevLogStatus {
  COMPLETED   // Already implemented
  IN_PROGRESS // Currently working on
  PLANNED     // Planned for future
  BLOCKED     // Blocked or delayed
}

// Agents playground: chat and share ideas (Moltbook agents, humans)
model PlaygroundMessage {
  id          String   @id @default(uuid())
  wallet      String?  // Optional: connected wallet (null for anonymous/agent)
  authorLabel String?  // Display name e.g. "Moltbook Agent", "Kogaion", or custom handle
  content     String   @db.Text
  createdAt   DateTime @default(now())

  @@index([createdAt])
}

// IDE & Contest: projects (HTML/CSS/JS/Python) and votes
model AgentProject {
  id           String   @id @default(uuid())
  title        String
  description  String?  @db.Text
  html         String?  @db.Text
  css          String?  @db.Text
  js           String?  @db.Text
  python       String?  @db.Text
  authorWallet String?
  authorLabel  String?
  language     String?  // e.g. "html" | "python"
  thumbnail    String?  @db.Text
  voteCount    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  votes        ProjectVote[]

  @@index([createdAt])
  @@index([authorWallet])
  @@index([authorLabel])
  @@index([voteCount])
}

model ProjectVote {
  id          String   @id @default(uuid())
  projectId   String
  voterKey    String   // wallet or fingerprint (required for uniqueness)
  voterWallet String?
  voterLabel  String?
  createdAt   DateTime @default(now())

  project     AgentProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, voterKey])
  @@index([projectId])
  @@index([voterWallet])
}

// ============================================
// AGENT MEMORY SYSTEM
// ============================================

model Agent {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  dna         Json?    // Personality traits, capabilities
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  
  memories    AgentMemory[]
  sessions    AgentSession[]
  knowledge   AgentKnowledge[]
  
  @@index([name])
}

model AgentMemory {
  id          String   @id @default(uuid())
  agentId     String
  type        MemoryType
  content     String   @db.Text
  embedding   Bytes?   // Optional: store embedding as bytea (enable pgvector later for vector(1536) if needed)
  importance  Float    @default(0.5)
  source      String?  // Where this came from
  entities    String[] // Entity mentions
  tags        String[]
  createdAt   DateTime @default(now())
  accessedAt  DateTime @default(now())
  accessCount Int      @default(0)
  
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  @@index([agentId])
  @@index([type])
  @@index([importance])
  @@index([createdAt])
}

enum MemoryType {
  EPISODIC      // Specific experiences/events
  SEMANTIC      // General knowledge/facts
  PROCEDURAL    // How-to knowledge
  WORKING       // Current session data
  PREFERENCE    // User preferences
  RELATIONSHIP  // Entity relationships
}

model AgentSession {
  id          String   @id @default(uuid())
  agentId     String
  summary     String?  @db.Text
  decisions   Json?    // Array of decisions made
  outcomes    Json?    // Results of decisions
  startedAt   DateTime @default(now())
  endedAt     DateTime?
  
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  @@index([agentId])
  @@index([startedAt])
}

model AgentKnowledge {
  id          String   @id @default(uuid())
  agentId     String
  entity      String   // e.g., "Solana", "DeFi", "User123"
  entityType  String   // e.g., "protocol", "concept", "wallet"
  properties  Json     // Entity properties
  confidence  Float    @default(1.0)  // Certainty level
  source      String?  // Where this was learned
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  @@unique([agentId, entity])
  @@index([agentId])
  @@index([entity])
  @@index([entityType])
}

// ============================================
// AGENT MARKETPLACE
// ============================================

model AgentService {
  id            String   @id @default(uuid())
  providerAgent String   // Agent name
  name          String
  description   String   @db.Text
  endpoints     String[] // API endpoints
  pricing       Json     // {unit, price, currency}
  capabilities String[]
  rating        Float    @default(0)
  reviewCount   Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt
  
  reviews       AgentReview[]
  
  @@index([providerAgent])
  @@index([capabilities])
}

model AgentReview {
  id            String   @id @default(uuid())
  serviceId     String
  reviewerAgent String
  rating        Int      // 1-5
  comment       String?  @db.Text
  createdAt     DateTime @default(now())
  
  service       AgentService @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  @@index([serviceId])
  @@index([reviewerAgent])
}
