// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Token {
  id          String   @id @default(uuid())
  mint        String   @unique
  name        String
  symbol      String
  imageUrl    String?
  metadataUri String
  dbcPool     String?  // DBC pool address
  creatorWallet String
  configKey   String
  createdAt   DateTime @default(now())
  
  metrics     Metric[]
  
  @@index([mint])
  @@index([creatorWallet])
  @@index([createdAt])
}

model Metric {
  id         String   @id @default(uuid())
  tokenMint  String
  price      Float?   @default(0)
  mcap       Float?   @default(0)
  vol24h     Float?   @default(0)
  holders    Int?     @default(0)
  updatedAt  DateTime @default(now()) @updatedAt
  
  token      Token    @relation(fields: [tokenMint], references: [mint], onDelete: Cascade)
  
  @@unique([tokenMint])
  @@index([tokenMint])
  @@index([updatedAt])
}

model BotPersona {
  id          String   @id @default(uuid())
  tokenMint   String   @unique
  systemPrompt String  // Final user-owned system prompt
  traitsJson  String   // JSON string of traits array
  allowed     String?  // JSON string of allowed topics/words
  forbidden   String?  // JSON string of forbidden topics/words
  tone        String   // e.g., "meme", "professional", "shill", etc.
  // Extended persona fields (user-owned)
  personaStyleJson String? // JSON: { chaos, friendliness, formality, aggression, humor } (0-100)
  brandingJson String?     // JSON: { catchphrases, emojis, voiceStyle, doList, dontList }
  presetUsed String?        // Which preset was used (Fire/Frost/Blood/Moon/Stone) or "custom"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  
  telegramBot TelegramBot?
  
  @@index([tokenMint])
}

model TelegramBot {
  id            String      @id @default(uuid())
  tokenMint     String      @unique
  encryptedToken String     // AES-GCM encrypted BotFather token
  status        BotStatus   @default(PENDING)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @default(now()) @updatedAt
  
  persona       BotPersona  @relation(fields: [tokenMint], references: [tokenMint], onDelete: Cascade)
  
  @@index([tokenMint])
  @@index([status])
}

enum BotStatus {
  PENDING
  ACTIVE
  INACTIVE
  ERROR
}

model Comment {
  id          String   @id @default(uuid())
  tokenMint   String
  wallet      String
  content     String
  createdAt   DateTime @default(now())
  
  @@index([tokenMint])
  @@index([createdAt])
}

model Referral {
  id            String   @id @default(uuid())
  referrerWallet String
  referredWallet String
  createdAt     DateTime @default(now())
  
  @@unique([referrerWallet, referredWallet])
  @@index([referrerWallet])
  @@index([referredWallet])
}

model ServiceProvider {
  id            String   @id @default(uuid())
  wallet        String   @unique // Solana wallet address
  email         String?
  telegram      String?
  twitterHandle String?  // Twitter username (fără @)
  twitterId     String?  // Twitter user ID pentru verificare
  description   String? // Descrierea serviciilor oferite
  verified      Boolean  @default(false) // Verificat prin Twitter
  verifiedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt
  
  tags          ServiceProviderTag[]
  twitterVerification TwitterVerification?
  
  @@index([wallet])
  @@index([verified])
  @@index([createdAt])
}

model ServiceProviderTag {
  id                String   @id @default(uuid())
  serviceProviderId String
  tag               String   // Tag name (predefined sau custom)
  isCustom          Boolean  @default(false) // Dacă e tag custom
  createdAt         DateTime @default(now())
  
  serviceProvider   ServiceProvider @relation(fields: [serviceProviderId], references: [id], onDelete: Cascade)
  
  @@index([serviceProviderId])
  @@index([tag])
}

model TwitterVerification {
  id                String   @id @default(uuid())
  serviceProviderId String   @unique
  verificationCode  String   // Cod unic pentru verificare
  tweetId           String?  // ID-ul tweet-ului de verificare
  status            VerificationStatus @default(PENDING)
  createdAt         DateTime @default(now())
  verifiedAt        DateTime?
  
  serviceProvider   ServiceProvider @relation(fields: [serviceProviderId], references: [id], onDelete: Cascade)
  
  @@index([verificationCode])
  @@index([status])
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FAILED
  EXPIRED
}
